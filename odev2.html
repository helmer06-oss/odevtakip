<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>tolgaaydos.com - Ã–dev Takip Sistemi</title>

  <link rel="icon" type="image/png" href="logo.png" />

  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --blue:#1677ff;
      --green:#22c55e;
      --shadow: 0 14px 34px rgba(2,6,23,.10);
      --radius: 18px;
      --ring: 0 0 0 3px rgba(22,119,255,.15);
      font-synthesis-weight:none;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    .wrap{max-width:780px;margin:0 auto;padding:20px 14px 44px;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .brand{
      display:flex;align-items:center;gap:14px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#ffffff,#fbfbfd);
    }
    .brand img{
      width:56px;height:56px;object-fit:contain;
      border-radius:14px;border:1px solid var(--line);
      background:#fff;flex:0 0 auto;
    }
    .brand .t1{font-weight:900;letter-spacing:.2px;font-size:24px;line-height:1.05;}
    .brand .t2{margin-top:2px;font-weight:800;font-size:20px;color:#111827;line-height:1.1;}
    .content{padding:18px 16px 20px;}

    label{display:block;font-size:13px;font-weight:800;color:#111827;margin:12px 0 6px;}
    input, select{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      font-size:15px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{box-shadow:var(--ring);border-color:#bcd7ff;}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:640px){.row{grid-template-columns:1fr;}}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .btn{
      border:none;border-radius:14px;padding:12px 14px;
      font-weight:900;font-size:15px;cursor:pointer;width:100%;
      user-select:none;
    }
    .btn.blue{background:var(--blue);color:#fff;}
    .btn.green{background:var(--green);color:#fff;}
    .btn.ghost{background:#f1f5f9;color:#111827;border:1px solid var(--line);}
    .btn.secondary{background:#eef2ff;color:#111827;border:1px solid #dbeafe;}
    .btn.danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;}
    .btn:disabled{opacity:.45;cursor:not-allowed;}

    .sep{height:1px;background:var(--line);margin:14px 0;}
    .muted{color:var(--muted);}
    .small{font-size:12px;}
    .status{margin-top:10px;font-size:13px;color:var(--muted);}

    details{margin-top:14px;border-top:1px dashed var(--line);padding-top:12px;}
    summary{cursor:pointer;font-weight:900;color:#111827;margin-bottom:10px;}

    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;vertical-align:top;}
    th{color:var(--muted);font-weight:800;font-size:12px;}
    .tag{
      display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;
      background:#f1f5f9;border:1px solid var(--line);color:#111827;margin-left:6px;font-weight:800;
    }
    .tinyRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    @media (max-width:640px){.tinyRow{grid-template-columns:1fr;}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="brand">
        <img src="logo.png" alt="Tolga Aydos Logo" onerror="this.style.display='none'">
        <div>
          <div class="t1">tolgaaydos.com</div>
          <div class="t2">Ã–dev Takip Sistemi</div>
        </div>
      </div>

      <div class="content">

        <label>Ã–ÄŸrenci Listesi:</label>
        <div class="row">
          <select id="studentSelect">
            <option value="">Ã–ÄŸrenci seÃ§iniz...</option>
          </select>
          <button class="btn ghost" id="addStudentBtn" type="button">â• Ã–ÄŸrenciyi Listeye Ekle</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn ghost" id="renameStudentBtn" type="button">âœï¸ Ã–ÄŸrenci AdÄ± DÃ¼zenle</button>
          <button class="btn danger" id="deleteStudentBtn" type="button">ğŸ—‘ï¸ Ã–ÄŸrenciyi Sil</button>
        </div>

        <label>Ã–ÄŸrenci AdÄ± SoyadÄ±:</label>
        <input id="student" type="text" placeholder="Ã–rn: Irmak" />

        <label>Tarih AralÄ±ÄŸÄ±:</label>
        <div class="row">
          <input id="startDate" type="date" />
          <input id="endDate" type="date" />
        </div>
        <div class="muted small" style="margin-top:6px;">
          Ä°pucu: Tek gÃ¼n iÃ§in baÅŸlangÄ±Ã§ ve bitiÅŸi aynÄ± seÃ§. â€œHaftalÄ±k Ã–zetâ€ seÃ§ili aralÄ±ÄŸÄ± kullanÄ±r; aralÄ±k seÃ§mezsen son 7 gÃ¼nÃ¼ gÃ¶nderir.
        </div>

        <label>GÃ¼nlÃ¼k GÃ¶nderim Tarihi (tek gÃ¼n): <span class="tag" id="singleTag">-</span></label>
        <input id="date" type="date" />

        <label>Kitap SeÃ§imi:</label>
        <select id="book">
          <option value="">Kitap SeÃ§iniz...</option>
        </select>

        <div class="row" style="margin-top:10px;">
          <button class="btn ghost" id="addBookBtn" type="button">â• Kitap Ekle</button>
          <button class="btn ghost" id="renameBookBtn" type="button">âœï¸ Kitap AdÄ± DÃ¼zenle</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn danger" id="deleteBookBtn" type="button">ğŸ—‘ï¸ KitabÄ± Sil</button>
          <button class="btn secondary" id="resetBooksBtn" type="button">â†º VarsayÄ±lan KitaplarÄ± YÃ¼kle</button>
        </div>

        <label>Sayfa AralÄ±ÄŸÄ±:</label>
        <div class="row">
          <input id="pStart" type="number" min="0" placeholder="BaÅŸlangÄ±Ã§ (Ã¶rn. 10)" />
          <input id="pEnd" type="number" min="0" placeholder="BitiÅŸ (Ã¶rn. 15)" />
        </div>

        <div class="btnRow">
          <button class="btn blue" id="addBtn" type="button">Listeye Ekle (SeÃ§ili AralÄ±ÄŸa)</button>
        </div>

        <div class="sep"></div>

        <div class="btnRow">
          <button class="btn green" id="waBtn" type="button">ğŸ“² WhatsApp ile GÃ¶nder (SeÃ§ili GÃ¼n)</button>
          <button class="btn ghost" id="weeklyBtn" type="button">ğŸ“… HaftalÄ±k Ã–dev Ã–zeti (WhatsApp)</button>
        </div>

        <div class="tinyRow">
          <button class="btn ghost" id="copyBtn" type="button">Metni Kopyala</button>
          <button class="btn ghost" id="todayBtn" type="button">BugÃ¼n</button>
        </div>

        <div class="status" id="status">HazÄ±r.</div>

        <details>
          <summary>â–¶ KayÄ±tlarÄ± GÃ¶ster / YÃ¶net</summary>

          <div class="muted small" style="margin-bottom:10px;">
            KayÄ±tlar cihazÄ±nÄ±zda saklanÄ±r. AynÄ± cihaz + aynÄ± site adresinde kaldÄ±ÄŸÄ± sÃ¼rece silinmez.
          </div>

          <div class="row">
            <button class="btn ghost" id="exportBtn" type="button">â¬‡ï¸ Yedek (JSON) Ä°ndir</button>
            <button class="btn ghost" id="importBtn" type="button">â¬†ï¸ Yedek (JSON) YÃ¼kle</button>
          </div>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />

          <div class="row" style="margin-top:10px;">
            <button class="btn danger" id="wipeBtn" type="button">ğŸ§¨ TÃ¼m KayÄ±tlarÄ± SÄ±fÄ±rla</button>
            <button class="btn secondary" id="rebuildBtn" type="button">ğŸ› ï¸ Listeyi Yenile</button>
          </div>

          <div class="sep"></div>
          <div id="tableWrap"></div>
        </details>

      </div>
    </div>
  </div>

<script>
/* =========================
   Sabit VarsayÄ±lanlar (senin listelerin)
========================= */
const STORAGE_KEY = "TA_ODEV_DB_V3";

// âœ… VarsayÄ±lan kitaplar (senin verdiÄŸin)
const DEFAULT_BOOKS = [
  "HÄ±z Fen Bilimleri Soru BankasÄ±",
  "Fen Fotokopi",
  "Sinan Kuzucu Fen Bilimleri Soru BankasÄ±",
  "Ben Korkmam Fen Bilimleri Soru BankasÄ±",
  "GÃ¼Ã§lendiren Fen Bilimleri Soru BankasÄ±"
];

// âœ… VarsayÄ±lan Ã¶ÄŸrenciler (senin verdiÄŸin)
const DEFAULT_STUDENTS = [
  "Irmak",
  "Cemre",
  "Bora",
  "BuÄŸlem-TuÄŸsem",
  "AyÅŸe ZÃ¼mra",
  "Derin",
  "ArÄ±n",
  "Derin7",
  "Mert",
  "Esma7",
  "Mehmet"
];

/* =========================
   KalÄ±cÄ± Veri (localStorage)
========================= */
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const db = JSON.parse(raw);
      db.students = db.students || {};
      db.books = Array.isArray(db.books) ? db.books : [];
      return db;
    }
  }catch(e){}

  // ilk kurulum: varsayÄ±lanlar
  const init = { students:{}, books: DEFAULT_BOOKS.slice(), createdAt: new Date().toISOString() };
  DEFAULT_STUDENTS.forEach(n=>{
    init.students[n] = { assignments: [] };
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
  return init;
}
function save(db){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   YardÄ±mcÄ±lar
========================= */
const $ = (id)=>document.getElementById(id);

function setStatus(msg){ $("status").textContent = msg; }

function trDate(iso){
  if(!iso) return "-";
  const p = iso.split("-");
  if(p.length!==3) return iso;
  return `${p[2]}.${p[1]}.${p[0]}`;
}

function normalizeName(s){
  return (s||"").trim().replace(/\s+/g," ");
}

function ensureStudent(db, name){
  db.students = db.students || {};
  if(!db.students[name]){
    db.students[name] = { assignments: [] };
  }
}

function pageText(pStart, pEnd){
  const s = String(pStart||"").trim();
  const e = String(pEnd||"").trim();
  if(!s && !e) return "-";
  if(s && e) return `${s}-${e}`;
  return s || e || "-";
}

/* =========================
   Tarih AralÄ±ÄŸÄ±
========================= */
function getSelectedDates(){
  const s = $("startDate")?.value;
  const e = $("endDate")?.value;

  if(!s || !e){
    const single = $("date")?.value;
    return single ? [single] : [];
  }
  if(s > e){
    alert("BaÅŸlangÄ±Ã§ tarihi, bitiÅŸ tarihinden bÃ¼yÃ¼k olamaz.");
    return [];
  }
  const dates = [];
  let cur = new Date(s);
  const end = new Date(e);
  cur.setHours(12,0,0,0);
  end.setHours(12,0,0,0);
  while(cur <= end){
    dates.push(cur.toISOString().slice(0,10));
    cur.setDate(cur.getDate()+1);
  }
  return dates;
}

function updateSingleDateTag(){
  const d = $("date").value;
  $("singleTag").textContent = d ? trDate(d) : "-";
}

/* =========================
   Ã–ÄŸrenci Listesi UI
========================= */
function refreshStudentSelect(){
  const db = load();
  const sel = $("studentSelect");
  if(!sel) return;

  const names = Object.keys(db.students||{}).sort((a,b)=>a.localeCompare(b,"tr"));
  const current = sel.value;

  sel.innerHTML = `<option value="">Ã–ÄŸrenci seÃ§iniz...</option>` +
    names.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");

  if(names.includes(current)) sel.value = current;
}

function addStudentToList(){
  const name = normalizeName($("student").value);
  if(!name) return alert("Ã–ÄŸrenci adÄ± yazÄ±nÄ±z.");

  const db = load();
  ensureStudent(db, name);
  save(db);

  refreshStudentSelect();
  $("studentSelect").value = name;
  setStatus(`Ã–ÄŸrenci eklendi: ${name}`);
}

function renameStudentInList(){
  const sel = $("studentSelect");
  const oldName = normalizeName(sel.value);
  if(!oldName) return alert("Ã–nce listeden Ã¶ÄŸrenci seÃ§iniz.");

  const nn = normalizeName(prompt("Yeni Ã¶ÄŸrenci adÄ±:", oldName));
  if(!nn) return;
  if(nn === oldName) return;

  const db = load();
  if(db.students[nn]) return alert("Bu isim zaten var.");

  db.students[nn] = db.students[oldName];
  delete db.students[oldName];
  save(db);

  refreshStudentSelect();
  $("studentSelect").value = nn;
  $("student").value = nn;
  setStatus("Ã–ÄŸrenci adÄ± gÃ¼ncellendi.");
  renderTable();
}

function deleteStudentFromList(){
  const sel = $("studentSelect");
  const name = normalizeName(sel.value);
  if(!name) return alert("Ã–nce listeden Ã¶ÄŸrenci seÃ§iniz.");

  if(!confirm(`"${name}" Ã¶ÄŸrencisini silmek istiyor musunuz?\n(Ã–dev kayÄ±tlarÄ± da silinir)`)) return;

  const db = load();
  delete db.students[name];
  save(db);

  refreshStudentSelect();
  $("student").value = "";
  sel.value = "";
  setStatus("Ã–ÄŸrenci silindi.");
  renderTable();
}

/* =========================
   Kitap Listesi UI
========================= */
function refreshBookSelect(){
  const db = load();
  const sel = $("book");
  if(!sel) return;

  const current = sel.value;
  const books = (db.books||[]).slice().sort((a,b)=>a.localeCompare(b,"tr"));

  sel.innerHTML = `<option value="">Kitap SeÃ§iniz...</option>` +
    books.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join("");

  if(books.includes(current)) sel.value = current;
}

function addBook(){
  const book = normalizeName(prompt("Eklenecek kitap adÄ±:",""));
  if(!book) return;

  const db = load();
  db.books = Array.isArray(db.books)?db.books:[];
  if(db.books.includes(book)) return alert("Bu kitap zaten listede var.");

  db.books.push(book);
  save(db);

  refreshBookSelect();
  $("book").value = book;
  setStatus("Kitap eklendi.");
}

function renameBook(){
  const oldName = normalizeName($("book").value);
  if(!oldName) return alert("Ã–nce bir kitap seÃ§iniz.");

  const nn = normalizeName(prompt("Yeni kitap adÄ±:", oldName));
  if(!nn) return;
  if(nn === oldName) return;

  const db = load();
  if(db.books.includes(nn)) return alert("Bu isim zaten var.");

  db.books = db.books.map(b => (b===oldName ? nn : b));

  Object.keys(db.students||{}).forEach(s=>{
    db.students[s].assignments?.forEach(a=>{
      if(a.book === oldName) a.book = nn;
    });
  });

  save(db);
  refreshBookSelect();
  $("book").value = nn;
  setStatus("Kitap adÄ± gÃ¼ncellendi.");
  renderTable();
}

function deleteBook(){
  const book = normalizeName($("book").value);
  if(!book) return alert("Ã–nce bir kitap seÃ§iniz.");
  if(!confirm(`"${book}" kitabÄ±nÄ± listeden silmek istiyor musunuz?`)) return;

  const db = load();
  db.books = (db.books||[]).filter(b=>b!==book);
  save(db);

  refreshBookSelect();
  setStatus("Kitap silindi.");
}

function resetBooks(){
  if(!confirm("VarsayÄ±lan kitap listesi yÃ¼klensin mi?\n(Mevcut eklediÄŸiniz kitaplar sÄ±fÄ±rlanÄ±r)")) return;
  const db = load();
  db.books = DEFAULT_BOOKS.slice();
  save(db);
  refreshBookSelect();
  setStatus("VarsayÄ±lan kitaplar yÃ¼klendi.");
}

/* =========================
   Ã–dev Ekle (Tarih AralÄ±ÄŸÄ±na)
========================= */
function addAssignments(){
  const studentName = normalizeName($("student").value);
  if(!studentName) return alert("Ã–ÄŸrenci adÄ± giriniz.");

  const book = normalizeName($("book").value);
  if(!book) return alert("Kitap seÃ§iniz.");

  const db = load();

  // kitap listesinde yoksa otomatik ekle (manuel ekleme destek)
  if(!db.books.includes(book)){
    db.books.push(book);
  }

  const pStart = $("pStart").value;
  const pEnd = $("pEnd").value;

  const dates = getSelectedDates();
  if(dates.length === 0) return alert("Tarih seÃ§iniz.");

  const isRange = dates.length > 1;
  if(isRange){
    const ok = confirm(`Bu Ã¶devi seÃ§tiÄŸiniz tarih aralÄ±ÄŸÄ±ndaki ${dates.length} gÃ¼ne birden ekleyeyim mi?\n(${trDate(dates[0])} - ${trDate(dates[dates.length-1])})`);
    if(!ok) return;
  }

  ensureStudent(db, studentName);

  dates.forEach(dISO=>{
    const list = db.students[studentName].assignments;
    const existing = list.find(a => a.date === dISO && a.book === book);
    if(existing){
      existing.pStart = pStart;
      existing.pEnd = pEnd;
      existing.updatedAt = new Date().toISOString();
    }else{
      list.push({ date: dISO, book, pStart, pEnd, createdAt: new Date().toISOString() });
    }
  });

  save(db);

  refreshStudentSelect();
  $("studentSelect").value = studentName;
  refreshBookSelect();

  setStatus(`Ã–dev kaydedildi: ${studentName} â€¢ ${book} â€¢ ${pageText(pStart,pEnd)} â€¢ ${isRange ? (trDate(dates[0])+"-"+trDate(dates[dates.length-1])) : trDate(dates[0])}`);
  renderTable();
}

/* =========================
   WhatsApp MesajlarÄ±
========================= */
function buildDailyMessage(studentName, dateISO){
  const db = load();
  const rec = db.students?.[studentName];
  if(!rec) return "";

  const list = (rec.assignments||[]).filter(a => a.date === dateISO);
  if(list.length === 0) return "";

  const grouped = {};
  list.forEach(a=>{
    grouped[a.book] = grouped[a.book] || [];
    grouped[a.book].push(pageText(a.pStart,a.pEnd));
  });

  const lines = [];
  lines.push("*tolgaaydos.com* | *Ã–dev Takip Sistemi*");
  lines.push("");
  lines.push(`ğŸ“… *Tarih:* ${trDate(dateISO)}`);
  lines.push(`ğŸ“ *Ã–ÄŸrenci:* ${studentName}`);
  lines.push("");
  lines.push("ğŸ“š *Ã–DEVLER*");

  let i=1;
  Object.keys(grouped).forEach(book=>{
    lines.push(`${i}) *${book}*`);
    lines.push(`   â–¸ Sayfa: ${grouped[book].join(", ")}`);
    i++;
  });

  lines.push("");
  lines.push("_Ä°yi Ã§alÄ±ÅŸmalar._");
  lines.push("*Tolga Hoca*");
  return lines.join("\n");
}

function sendWhatsAppDaily(){
  const studentName = normalizeName($("student").value);
  if(!studentName) return alert("Ã–ÄŸrenci adÄ± giriniz.");

  const dateISO = $("date").value;
  if(!dateISO) return alert("GÃ¼nlÃ¼k gÃ¶nderim tarihi seÃ§iniz.");

  const msg = buildDailyMessage(studentName, dateISO);
  if(!msg) return alert("Bu Ã¶ÄŸrenci iÃ§in bu tarihte kayÄ±tlÄ± Ã¶dev yok.");

  location.href = "https://wa.me/?text=" + encodeURIComponent(msg);
}

function buildRangeSummary(studentName, startISO, endISO){
  const db = load();
  const rec = db.students?.[studentName];
  if(!rec) return "";

  const start = new Date(startISO); start.setHours(0,0,0,0);
  const end = new Date(endISO); end.setHours(23,59,59,999);

  const list = (rec.assignments||[]).filter(a=>{
    if(!a.date) return false;
    const d = new Date(a.date);
    return d >= start && d <= end;
  });
  if(list.length === 0) return "";

  const byDate = {};
  list.forEach(a=>{
    byDate[a.date] = byDate[a.date] || [];
    byDate[a.date].push(a);
  });

  const dates = Object.keys(byDate).sort();

  const lines = [];
  lines.push("*tolgaaydos.com* | *Ã–dev Ã–zeti*");
  lines.push(`ğŸ“ *Ã–ÄŸrenci:* ${studentName}`);
  lines.push(`ğŸ“… *AralÄ±k:* ${trDate(dates[0])} - ${trDate(dates[dates.length-1])}`);
  lines.push("");
  lines.push("ğŸ“š *Ã–DEVLER*");

  dates.forEach(dISO=>{
    lines.push("");
    lines.push(`ğŸ—“ï¸ *${trDate(dISO)}*`);

    const grouped = {};
    byDate[dISO].forEach(a=>{
      grouped[a.book] = grouped[a.book] || [];
      grouped[a.book].push(pageText(a.pStart,a.pEnd));
    });

    let i=1;
    Object.keys(grouped).forEach(book=>{
      lines.push(`${i}) *${book}*`);
      lines.push(`   â–¸ Sayfa: ${grouped[book].join(", ")}`);
      i++;
    });
  });

  lines.push("");
  lines.push("_Ä°yi Ã§alÄ±ÅŸmalar._");
  lines.push("*Tolga Hoca*");
  return lines.join("\n");
}

function sendWeeklySummary(){
  const studentName = normalizeName($("student").value);
  if(!studentName) return alert("Ã–ÄŸrenci adÄ± giriniz.");

  let s = $("startDate").value;
  let e = $("endDate").value;

  // aralÄ±k varsa onu kullan
  if(s && e && s <= e && !(s===e)){
    const msg = buildRangeSummary(studentName, s, e);
    if(!msg) return alert("SeÃ§tiÄŸiniz aralÄ±kta kayÄ±tlÄ± Ã¶dev yok.");
    location.href = "https://wa.me/?text=" + encodeURIComponent(msg);
    return;
  }

  // yoksa son 7 gÃ¼n
  const end = new Date(); end.setHours(23,59,59,999);
  const start = new Date(); start.setDate(start.getDate()-6); start.setHours(0,0,0,0);

  const msg = buildRangeSummary(studentName, start.toISOString().slice(0,10), end.toISOString().slice(0,10));
  if(!msg) return alert("Son 7 gÃ¼n iÃ§inde kayÄ±tlÄ± Ã¶dev yok.");

  location.href = "https://wa.me/?text=" + encodeURIComponent(msg);
}

/* =========================
   Kopyala / BugÃ¼n
========================= */
async function copyCurrentMessage(){
  const studentName = normalizeName($("student").value);
  if(!studentName) return alert("Ã–ÄŸrenci adÄ± giriniz.");

  const dateISO = $("date").value;
  if(!dateISO) return alert("Tarih seÃ§iniz.");

  const msg = buildDailyMessage(studentName, dateISO);
  if(!msg) return alert("Bu tarihte kayÄ±tlÄ± Ã¶dev yok.");

  try{
    await navigator.clipboard.writeText(msg);
    setStatus("Metin panoya kopyalandÄ± âœ…");
  }catch(e){
    prompt("Kopyalamak iÃ§in basÄ±lÄ± tutup kopyalayÄ±n:", msg);
  }
}

function setToday(){
  const today = new Date().toISOString().slice(0,10);
  $("date").value = today;
  $("startDate").value = today;
  $("endDate").value = today;
  updateSingleDateTag();
  setStatus("BugÃ¼n seÃ§ildi.");
}

/* =========================
   Tablo
========================= */
function renderTable(){
  const db = load();
  const wrap = $("tableWrap");
  if(!wrap) return;

  const rows = [];
  Object.keys(db.students||{}).sort((a,b)=>a.localeCompare(b,"tr")).forEach(student=>{
    const list = db.students[student].assignments || [];
    list.forEach(a=>{
      rows.push({ student, date: a.date || "", book: a.book || "", pages: pageText(a.pStart,a.pEnd) });
    });
  });

  rows.sort((r1,r2)=>{
    if(r1.student !== r2.student) return r1.student.localeCompare(r2.student,"tr");
    if(r1.date !== r2.date) return (r1.date||"").localeCompare(r2.date||"");
    return (r1.book||"").localeCompare(r2.book||"","tr");
  });

  if(rows.length === 0){
    wrap.innerHTML = `<div class="muted small">HenÃ¼z kayÄ±t yok.</div>`;
    return;
  }

  wrap.innerHTML = `
    <table>
      <thead>
        <tr><th>Ã–ÄŸrenci</th><th>Tarih</th><th>Kitap</th><th>Sayfa</th></tr>
      </thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td><b>${escapeHtml(r.student)}</b></td>
            <td>${escapeHtml(trDate(r.date))}</td>
            <td>${escapeHtml(r.book)}</td>
            <td>${escapeHtml(r.pages)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

/* =========================
   Yedek / Geri YÃ¼kle
========================= */
function exportJSON(){
  const db = load();
  const blob = new Blob([JSON.stringify(db,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "odev-takip-yedek.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  setStatus("Yedek indirildi.");
}

function importJSON(){ $("importFile").click(); }

function handleImportFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const db = JSON.parse(reader.result);
      if(!db || typeof db !== "object") throw new Error("GeÃ§ersiz");
      db.students = db.students || {};
      db.books = Array.isArray(db.books) ? db.books : DEFAULT_BOOKS.slice();
      save(db);

      refreshStudentSelect();
      refreshBookSelect();
      renderTable();
      setStatus("Yedek yÃ¼klendi âœ…");
    }catch(e){
      alert("Yedek dosyasÄ± okunamadÄ±.");
    }
  };
  reader.readAsText(file);
}

function wipeAll(){
  if(!confirm("TÃ¼m kayÄ±tlarÄ± SIFIRLAMAK istiyor musunuz?\n(Geri alÄ±namaz)")) return;
  localStorage.removeItem(STORAGE_KEY);
  load(); // yeniden kur
  refreshStudentSelect();
  refreshBookSelect();
  renderTable();
  setStatus("TÃ¼m kayÄ±tlar sÄ±fÄ±rlandÄ±.");
}

/* =========================
   BaÅŸlat
========================= */
document.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().slice(0,10);
  if(!$("date").value) $("date").value = today;
  if(!$("startDate").value) $("startDate").value = today;
  if(!$("endDate").value) $("endDate").value = today;

  updateSingleDateTag();

  $("studentSelect").addEventListener("change", ()=>{
    $("student").value = $("studentSelect").value || "";
  });
  $("student").addEventListener("input", ()=>{ $("studentSelect").value = ""; });

  $("startDate").addEventListener("change", ()=>{
    if($("startDate").value) $("date").value = $("startDate").value;
    updateSingleDateTag();
  });
  $("date").addEventListener("change", updateSingleDateTag);

  $("addBtn").addEventListener("click", addAssignments);
  $("waBtn").addEventListener("click", sendWhatsAppDaily);
  $("weeklyBtn").addEventListener("click", sendWeeklySummary);
  $("copyBtn").addEventListener("click", copyCurrentMessage);
  $("todayBtn").addEventListener("click", setToday);

  $("addStudentBtn").addEventListener("click", addStudentToList);
  $("renameStudentBtn").addEventListener("click", renameStudentInList);
  $("deleteStudentBtn").addEventListener("click", deleteStudentFromList);

  $("addBookBtn").addEventListener("click", addBook);
  $("renameBookBtn").addEventListener("click", renameBook);
  $("deleteBookBtn").addEventListener("click", deleteBook);
  $("resetBooksBtn").addEventListener("click", resetBooks);

  $("exportBtn").addEventListener("click", exportJSON);
  $("importBtn").addEventListener("click", importJSON);
  $("wipeBtn").addEventListener("click", wipeAll);
  $("rebuildBtn").addEventListener("click", ()=>{
    refreshStudentSelect();
    refreshBookSelect();
    renderTable();
    setStatus("Liste yenilendi.");
  });

  $("importFile").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) handleImportFile(f);
    e.target.value = "";
  });

  // ilk yÃ¼kleme
  refreshStudentSelect();
  refreshBookSelect();
  renderTable();
});
</script>
</body>
</html>

